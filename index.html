<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harita - Debug Modu</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; background: #222; font-family: 'Montserrat', sans-serif; }
        
        #map { height: 100%; width: 100%; background-color: #444; display: none; }

        /* DEBUG KONSOLU - Yeşil Yazılar */
        #debugConsole {
            position: fixed; top: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace;
            font-size: 11px; padding: 10px; z-index: 99999;
            overflow-y: auto; pointer-events: none; border-bottom: 2px solid #0f0;
            display: block;
        }

        /* --- UI STİLLERİ --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            z-index: 5000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.98); padding: 40px 30px;
            border-radius: 24px; width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .brand-name { font-size: 26px; font-weight: 800; color: #1e293b; margin-bottom: 5px; text-transform: uppercase; }
        .login-btn {
            display: block; width: 100%; padding: 16px; margin-bottom: 12px;
            border: none; border-radius: 12px; font-size: 15px; font-weight: bold;
            cursor: pointer;
        }
        .btn-guest { background: #f1f5f9; color: #475569; }
        .btn-user { background: #2563eb; color: white; }

        /* Marker Stili */
        .custom-div-icon { background: transparent; border: none; }
        .pin-wrapper { position: relative; width: 50px; height: 60px; }
        .pin-marker { position: absolute; width: 36px; height: 36px; background: #2563eb; border-radius: 50% 50% 50% 0; left: 7px; top: 0; border: 3px solid white; transform: rotate(-45deg); }
        .pin-number { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); color: white; font-weight: bold; font-size: 14px; background: #2563eb; padding: 4px 10px; border-radius: 12px; }
    </style>
</head>
<body>

<div id="debugConsole">Sistem başlatılıyor...<br></div>

<div id="loginScreen">
    <div class="login-container">
        <div class="brand-name">Hata Ayıklama Modu v2</div>
        <p style="margin-bottom:10px; color:#2563eb; font-size:12px;">Map Zoom Hatası Giderildi.</p>
        <button id="btnGuest" class="login-btn btn-guest">Misafir Olarak Başla</button>
        <button id="btnUser" class="login-btn btn-user">Kullanıcı Girişi</button>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    function log(msg) {
        const d = new Date();
        const time = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
        const el = document.getElementById("debugConsole");
        if(el) {
            el.innerHTML += `[${time}] ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }
        console.log(msg);
    }

    // Telefonda hataları yakalamak için
    window.onerror = function(msg, url, line) {
        log("KRİTİK HATA: " + msg + " (Satır: " + line + ")");
        return false;
    };

    const firebaseConfig = {
        apiKey: "AIzaSyBALVTNtwpBZEB4t8fhb7_I3nZJZzrnJU4",
        authDomain: "appharita.firebaseapp.com",
        databaseURL: "https://appharita-default-rtdb.firebaseio.com", 
        projectId: "appharita",
        storageBucket: "appharita.firebasestorage.app",
        messagingSenderId: "825896245452",
        appId: "1:825896245452:web:15ae33b66df6446d708a69",
        measurementId: "G-3GS17644DL"
    };

    let app, db, pointsRef;

    try {
        log("Firebase config yükleniyor...");
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        pointsRef = ref(db, "points");
        log("Firebase Hazır. Hedef: points");
    } catch (e) {
        log("FIREBASE BAŞLATILAMADI: " + e.message);
    }

    // --- HARİTA AYARLARI (DÜZELTİLEN KISIM) ---
    const southWest = L.latLng(41.947443, 34.756365);
    const northEast = L.latLng(41.952599, 34.764444);
    const bounds = L.latLngBounds(southWest, northEast);
    
    // BURASI ÇOK ÖNEMLİ: maxZoom: 22 eklendi. Hatayı bu çözecek.
    const map = L.map('map', { 
        center: bounds.getCenter(), 
        zoom: 16, 
        maxZoom: 22, // <-- İŞTE ÇÖZÜM BU SATIRDA
        zoomControl: false 
    });
    
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.imageOverlay('harita.jpg', bounds).addTo(map);
    map.fitBounds(bounds);

    const markersCluster = L.markerClusterGroup();
    map.addLayer(markersCluster);

    function createNumberIcon(num) {
        return L.divIcon({
            className: "custom-div-icon",
            html: `<div class="pin-wrapper"><div class="pin-marker"></div><div class="pin-number">${num}</div></div>`,
            iconSize: [50, 60], iconAnchor: [25, 60]
        });
    }

    // --- Firebase Veri Okuma ---
    log("Veri dinleyicisi kuruluyor...");
    
    onChildAdded(pointsRef, (snap) => {
        const d = snap.val();
        // Hata ayıklama için her veriyi yazmıyoruz, çok yer kaplar
        // Sadece ilk gelen veriyi kontrol edelim
        
        if (d && d.lat && d.lng) {
            try {
                const marker = L.marker([d.lat, d.lng], { icon: createNumberIcon(d.title || "?") });
                markersCluster.addLayer(marker);
                // Başarılı olursa log düşmeyelim, ekran dolmasın.
            } catch(err) {
                log("Marker çizim hatası: " + err.message);
            }
        }
    });

    // --- Bağlantı Özeti ---
    get(pointsRef).then(snapshot => {
        if(snapshot.exists()) {
            const count = snapshot.size; // Toplam veri sayısı
            log("BAĞLANTI BAŞARILI! Toplam " + count + " adet istif bulundu.");
            log("Harita üzerinde görünmesi lazım.");
        } else {
            log("UYARI: Bağlantı var ama hiç veri yok (Klasör boş).");
        }
    }).catch(error => {
        log("BAĞLANTI HATASI: " + error.code);
        log("Detay: " + error.message);
    });

    // --- Arayüz ---
    function initAppLayout() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        setTimeout(() => {
            map.invalidateSize();
            map.fitBounds(bounds);
        }, 500);
    }

    document.getElementById('btnGuest').addEventListener('click', () => initAppLayout());
    document.getElementById('btnUser').addEventListener('click', () => initAppLayout());

</script>
</body>
</html>
