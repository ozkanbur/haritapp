<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harita - Debug Modu</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; background: #222; font-family: 'Montserrat', sans-serif; }
        
        #map { height: 100%; width: 100%; background-color: #444; display: none; }

        /* DEBUG KONSOLU - Sorunu görmek için */
        #debugConsole {
            position: fixed; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0,0,0,0.85); color: #0f0; font-family: monospace;
            font-size: 11px; padding: 10px; z-index: 99999;
            overflow-y: auto; pointer-events: none; border-bottom: 2px solid #0f0;
            display: block;
        }

        /* --- UI STİLLERİ --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            z-index: 5000; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.98); padding: 40px 30px;
            border-radius: 24px; width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .brand-name { font-size: 26px; font-weight: 800; color: #1e293b; margin-bottom: 5px; text-transform: uppercase; }
        .login-btn {
            display: block; width: 100%; padding: 16px; margin-bottom: 12px;
            border: none; border-radius: 12px; font-size: 15px; font-weight: bold;
            cursor: pointer;
        }
        .btn-guest { background: #f1f5f9; color: #475569; }
        .btn-user { background: #2563eb; color: white; }
        .btn-admin { background: #0f172a; color: white; }

        /* Diğer Butonlar */
        .action-btn { position: absolute; right: 20px; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; z-index: 1000; display: none; align-items: center; justify-content: center; color: white; }
        #addMarkerBtn { top: 160px; background: #2563eb; } /* Debug konsolu yüzünden aşağı aldım */
        
        /* Marker Stili */
        .custom-div-icon { background: transparent; border: none; }
        .pin-wrapper { position: relative; width: 50px; height: 60px; }
        .pin-marker { position: absolute; width: 36px; height: 36px; background: #2563eb; border-radius: 50% 50% 50% 0; left: 7px; top: 0; border: 3px solid white; transform: rotate(-45deg); }
        .pin-number { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); color: white; font-weight: bold; font-size: 14px; background: #2563eb; padding: 4px 10px; border-radius: 12px; }
    </style>
</head>
<body>

<div id="debugConsole">Sistem başlatılıyor...<br></div>

<div id="loginScreen">
    <div class="login-container">
        <div class="brand-name">Hata Ayıklama Modu</div>
        <p style="margin-bottom:10px; color:red; font-size:12px;">Bu modda üstte yazan yazılar önemlidir.</p>
        <button id="btnGuest" class="login-btn btn-guest">Misafir Olarak Başla</button>
        <button id="btnUser" class="login-btn btn-user">Kullanıcı Girişi</button>
    </div>
</div>

<div id="map"></div>
<button id="addMarkerBtn" class="action-btn"><svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- EKRANA YAZDIRMA FONKSİYONU ---
    function log(msg) {
        const d = new Date();
        const time = d.getHours() + ":" + d.getMinutes() + ":" + d.getSeconds();
        const el = document.getElementById("debugConsole");
        el.innerHTML += `[${time}] ${msg}<br>`;
        el.scrollTop = el.scrollHeight;
        console.log(msg);
    }

    window.onerror = function(msg, url, line) {
        log("KRİTİK HATA: " + msg + " (Satır: " + line + ")");
    };

    const firebaseConfig = {
        apiKey: "AIzaSyBALVTNtwpBZEB4t8fhb7_I3nZJZzrnJU4",
        authDomain: "appharita.firebaseapp.com",
        // Lütfen buranın doğruluğundan %100 emin olun
        databaseURL: "https://appharita-default-rtdb.firebaseio.com", 
        projectId: "appharita",
        storageBucket: "appharita.firebasestorage.app",
        messagingSenderId: "825896245452",
        appId: "1:825896245452:web:15ae33b66df6446d708a69",
        measurementId: "G-3GS17644DL"
    };

    let app, db, pointsRef;

    // 1. Firebase Başlatma
    try {
        log("Firebase config yükleniyor...");
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        pointsRef = ref(db, "points");
        log("Firebase SDK yüklendi. Referans: points");
    } catch (e) {
        log("FIREBASE BAŞLATILAMADI: " + e.message);
    }

    // 2. Harita Hazırlığı
    const southWest = L.latLng(41.947443, 34.756365);
    const northEast = L.latLng(41.952599, 34.764444);
    const bounds = L.latLngBounds(southWest, northEast);
    const map = L.map('map', { center: bounds.getCenter(), zoom: 16, zoomControl: false });
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.imageOverlay('harita.jpg', bounds).addTo(map);
    const markersCluster = L.markerClusterGroup();
    map.addLayer(markersCluster);

    // Test Marker'ı (Firebase'den bağımsız çalışıp çalışmadığını görmek için)
    const testMarker = L.marker(bounds.getCenter()).addTo(map);
    testMarker.bindPopup("Bu bir TEST markerıdır. Harita çalışıyor.");
    
    // --- Marker Oluşturma ---
    function createNumberIcon(num) {
        return L.divIcon({
            className: "custom-div-icon",
            html: `<div class="pin-wrapper"><div class="pin-marker"></div><div class="pin-number">${num}</div></div>`,
            iconSize: [50, 60], iconAnchor: [25, 60]
        });
    }

    // --- Firebase Veri Okuma ---
    log("Veri dinleyicisi kuruluyor...");
    
    onChildAdded(pointsRef, (snap) => {
        log("Veri Geldi! ID: " + snap.key);
        const d = snap.val();
        
        // Veri içeriğini kontrol et
        if (!d) { log("HATA: Veri boş!"); return; }
        if (d.lat === undefined || d.lng === undefined) {
            log("HATA: lat/lng eksik! Gelen veri: " + JSON.stringify(d));
            return;
        }

        try {
            const marker = L.marker([d.lat, d.lng], { icon: createNumberIcon(d.title || "?") });
            markersCluster.addLayer(marker);
            log("Marker eklendi: " + d.title);
        } catch(err) {
            log("Marker çizim hatası: " + err.message);
        }
    });

    // --- Başlangıç Testi ---
    get(pointsRef).then(snapshot => {
        if(snapshot.exists()) {
            log("BAĞLANTI BAŞARILI: Veritabanında veri var.");
            log("Toplam kayıt sayısı (tahmini): " + snapshot.size);
        } else {
            log("UYARI: Bağlantı var ama 'points' klasörü BOŞ.");
        }
    }).catch(error => {
        log("BAĞLANTI HATASI (Get): " + error.code + " - " + error.message);
    });

    // --- Arayüz İşlemleri ---
    function initAppLayout() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        document.getElementById('addMarkerBtn').style.display = 'flex';
        
        setTimeout(() => {
            map.invalidateSize();
            map.fitBounds(bounds);
            log("Harita boyutu güncellendi ve odaklandı.");
        }, 500);
    }

    document.getElementById('btnGuest').addEventListener('click', () => {
        log("Misafir butonuna basıldı.");
        initAppLayout();
    });

    document.getElementById('btnUser').addEventListener('click', () => {
        log("Kullanıcı butonuna basıldı. (Şifresiz geçiş yapılıyor test için)");
        initAppLayout();
    });

</script>
</body>
</html>
